name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Read Flutter version
        id: fvm
        run: echo "FLUTTER_VERSION=$(jq -r '.flutter' .fvmrc)" >> "$GITHUB_OUTPUT"
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ steps.fvm.outputs.FLUTTER_VERSION }}
      - name: Link FVM SDK path
        run: mkdir -p .fvm && ln -s "$FLUTTER_ROOT" .fvm/flutter_sdk
      - run: dart pub get
      - run: dart pub global activate melos
      - run: melos run analyze

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Read Flutter version
        id: fvm
        run: echo "FLUTTER_VERSION=$(jq -r '.flutter' .fvmrc)" >> "$GITHUB_OUTPUT"
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ steps.fvm.outputs.FLUTTER_VERSION }}
      - name: Link FVM SDK path
        run: mkdir -p .fvm && ln -s "$FLUTTER_ROOT" .fvm/flutter_sdk
      - run: dart pub get
      - run: dart pub global activate melos
      - run: melos run test

  format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Read Flutter version
        id: fvm
        run: echo "FLUTTER_VERSION=$(jq -r '.flutter' .fvmrc)" >> "$GITHUB_OUTPUT"
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ steps.fvm.outputs.FLUTTER_VERSION }}
      - name: Link FVM SDK path
        run: mkdir -p .fvm && ln -s "$FLUTTER_ROOT" .fvm/flutter_sdk
      - run: dart pub get
      - run: dart format --set-exit-if-changed .
      - uses: dprint/check@v2.2

  secrets-scan:
    name: Secrets Detection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install gitleaks
        run: |
          GITLEAKS_VERSION=8.24.3
          curl -sSfL "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" \
            | tar xz -C /usr/local/bin gitleaks
      - name: Run gitleaks
        run: gitleaks detect --source . --verbose --redact
